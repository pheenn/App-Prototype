<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1" name="viewport" />
    <title>SafeStay Interactive Map</title>
    <link href="assets/css/plus-jakarta-sans.css" rel="stylesheet" />
    <link href="assets/css/material-symbols.css" rel="stylesheet" />
    <script src="assets/js/tailwindcdn.js"></script>
    <style type="text/tailwindcss">
      :root {
        --deep-navy: #1d3a6d;
        --sea-teal: #1fbca3;
        --warm-sand: #f7e4c3;
        --soft-gray: #eef2f6;
      }
    </style>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              "deep-navy": "var(--deep-navy)",
              "sea-teal": "var(--sea-teal)",
              "warm-sand": "var(--warm-sand)",
              "soft-gray": "var(--soft-gray)",
            },
            fontFamily: {
              sans: ["Plus Jakarta Sans", "sans-serif"],
            },
            boxShadow: {
              surface: "0 18px 45px -24px rgba(29, 58, 109, 0.45)",
              chip: "0 12px 32px -16px rgba(31, 188, 163, 0.65)",
            },
          },
        },
      };
    </script>
    <style>
      body {
        font-family: "Plus Jakarta Sans", sans-serif;
        background-color: var(--soft-gray);
        color: var(--deep-navy);
      }

      body {
        min-height: max(884px, 100dvh);
      }

      .map-canvas {
        position: relative;
        background-image: url("Images/map.png");
        background-size: calc(100% * var(--zoom-scale, 1));
        background-position: var(--background-x, 50%) var(--background-y, 50%);
        background-repeat: no-repeat;
        transition: background-size 200ms ease;
      }

      .marker-layer {
        position: absolute;
        inset: 0;
        transform-origin: top left;
        transform: scale(var(--zoom-scale, 1));
        pointer-events: none;
      }

      .marker-button {
        width: 40px;
        height: 52px;
        border-radius: 20px 20px 20px 2px;
        clip-path: path(
          "M20 0C9.04 0 .5 8.1.5 18.04c0 5.73 2.82 11.18 7.54 14.44l9.19 18.46c.6 1.2 2.31 1.2 2.9 0l9.2-18.48C34.06 29.2 37 23.75 37 18.04 37 8.1 28.49 0 17.52 0z"
        );
        background: linear-gradient(180deg, #1d3a6d 0%, #102449 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: #fff;
        font-size: 18px;
        pointer-events: auto;
        transition: transform 160ms ease, box-shadow 160ms ease;
      }

      .marker-button[data-active="true"] {
        transform: translateY(-6px) scale(1.05);
        box-shadow: 0 16px 34px -18px rgba(16, 36, 73, 0.65);
      }

      .marker-button[data-type="saved"] {
        background: linear-gradient(180deg, #1fbca3 0%, #168777 100%);
      }

      .marker-button[data-type="message"] {
        background: linear-gradient(180deg, #ff9a4d 0%, #ff7a23 100%);
      }

      .marker-cluster {
        width: 56px;
        height: 56px;
        border-radius: 50%;
        background: linear-gradient(180deg, #1fbca3 0%, #129580 100%);
        color: #fff;
        font-weight: 700;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 18px 32px -20px rgba(18, 149, 128, 0.75);
        pointer-events: none;
      }

      .filter-chip[data-checked="true"] {
        box-shadow: 0 12px 30px -16px rgba(29, 58, 109, 0.5);
      }

      .scrollbar-hidden {
        scrollbar-width: none;
      }

      .scrollbar-hidden::-webkit-scrollbar {
        display: none;
      }
    </style>
  </head>
  <body>
    <div class="flex h-screen flex-col">
      <header class="z-20 flex items-center justify-between px-5 pb-4 pt-6">
        <div>
          <p class="text-xs font-semibold uppercase tracking-[0.2em] text-sea-teal">
            Map Explorer
          </p>
          <h1 class="mt-1 text-lg font-bold text-deep-navy">
            Find a stay near your campus
          </h1>
        </div>
        <button
          id="toggleList"
          class="flex h-11 w-11 items-center justify-center rounded-full border border-white/50 bg-white/90 text-deep-navy shadow-sm backdrop-blur-lg transition hover:shadow-md"
          type="button"
        >
          <span class="material-symbols-outlined">list_alt</span>
        </button>
      </header>

      <main class="relative flex flex-1 flex-col">
        <section class="relative mx-5 flex flex-1 overflow-hidden rounded-3xl border border-white/70 bg-white shadow-surface">
          <div
            id="mapCanvas"
            aria-label="SafeStay map"
            class="map-canvas relative h-full w-full"
            role="application"
          >
            <div class="marker-layer" id="markerLayer"></div>
            <div class="marker-layer" id="clusterLayer"></div>

            <div class="pointer-events-none absolute inset-x-0 top-0 flex justify-center pt-6">
              <div class="inline-flex items-center gap-2 rounded-full border border-white/50 bg-white/90 px-4 py-2 text-xs font-semibold text-slate-600 shadow-sm backdrop-blur">
                <span class="material-symbols-outlined text-[16px] text-sea-teal">
                  verified
                </span>
                All prices in Philippine Peso (PHP)
              </div>
            </div>

            <div class="absolute right-4 top-4 z-10 flex flex-col gap-3">
              <div class="flex flex-col gap-2">
                <button
                  id="zoomIn"
                  class="flex h-10 w-10 items-center justify-center rounded-full border border-white/40 bg-white/95 text-deep-navy shadow-md transition hover:shadow-lg"
                  type="button"
                >
                  <span class="material-symbols-outlined">add</span>
                </button>
                <button
                  id="zoomOut"
                  class="flex h-10 w-10 items-center justify-center rounded-full border border-white/40 bg-white/95 text-deep-navy shadow-md transition hover:shadow-lg"
                  type="button"
                >
                  <span class="material-symbols-outlined">remove</span>
                </button>
              </div>
              <button
                id="openFilters"
                class="flex h-12 w-12 items-center justify-center rounded-full bg-deep-navy text-white shadow-chip transition hover:bg-opacity-95"
                type="button"
              >
                <span class="material-symbols-outlined">tune</span>
              </button>
            </div>

            <div class="pointer-events-none absolute bottom-6 left-6 rounded-2xl bg-white/90 px-4 py-2 text-xs font-semibold text-slate-500 shadow-sm backdrop-blur">
              Zoom <span class="px-1" id="zoomValue">100%</span>
            </div>
          </div>
        </section>

        <section
          id="listingPanel"
          class="pointer-events-none absolute inset-x-0 bottom-24 z-30 px-5 transition-transform duration-200 ease-out"
        >
          <article
            class="pointer-events-auto rounded-3xl bg-white/95 p-4 shadow-surface backdrop-blur-lg"
            id="listingCard"
          >
            <div class="flex items-start gap-4">
              <div class="relative h-24 w-24 flex-shrink-0 overflow-hidden rounded-2xl">
                <img
                  alt="Selected SafeStay listing"
                  class="h-full w-full object-cover"
                  id="listingImage"
                  src="Images/home bh 1.png"
                />
                <span
                  class="absolute left-2 top-2 inline-flex items-center gap-1 rounded-full bg-white/85 px-2 py-1 text-[11px] font-semibold text-deep-navy"
                  id="listingBadge"
                ></span>
              </div>
              <div class="flex flex-1 flex-col gap-3">
                <div class="flex items-start justify-between gap-2">
                  <div class="space-y-1">
                    <h2 class="text-base font-semibold leading-tight" id="listingTitle">
                      Sunset View Dormitory
                    </h2>
                    <p class="text-xs font-medium text-slate-500" id="listingLocation"></p>
                  </div>
                  <button
                    aria-label="Save listing"
                    class="flex h-9 w-9 items-center justify-center rounded-full border border-slate-200 bg-white text-sea-teal transition hover:border-sea-teal/50 hover:bg-sea-teal/10"
                    id="saveButton"
                    type="button"
                  >
                    <span class="material-symbols-outlined" id="saveIcon">favorite</span>
                  </button>
                </div>
                <div class="flex flex-wrap items-center gap-2 text-xs font-medium text-slate-500">
                  <span class="flex items-center gap-1 text-sea-teal">
                    <span class="material-symbols-outlined text-[16px]">star</span>
                    <span id="listingRating"></span>
                  </span>
                  <span id="listingReviews"></span>
                  <span class="inline-flex items-center gap-1 rounded-full bg-sea-teal/10 px-2 py-1 text-sea-teal" id="listingType"></span>
                </div>
                <div class="flex flex-col gap-3">
                  <div class="flex flex-wrap gap-2" id="listingAmenities"></div>
                  <div class="flex items-center justify-between">
                    <div>
                      <p class="text-xs text-slate-500">Starts at</p>
                      <p class="text-lg font-semibold text-deep-navy" id="listingPrice"></p>
                    </div>
                    <button
                      class="rounded-xl bg-deep-navy px-4 py-2 text-sm font-semibold text-white shadow-md transition hover:bg-opacity-90"
                      id="viewDetails"
                      type="button"
                    >
                      View Details
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </article>
        </section>

        <aside
          aria-hidden="true"
          class="fixed inset-x-0 bottom-0 z-40 translate-y-full border-t border-slate-100 bg-white/98 px-5 py-6 shadow-[0_-24px_64px_-40px_rgba(13,26,51,0.45)] transition-transform duration-200 ease-out"
          id="filterDrawer"
        >
          <div class="mx-auto max-w-lg">
            <div class="mb-6 flex items-center justify-between">
              <h2 class="text-lg font-semibold text-deep-navy">Filter listings</h2>
              <button
                id="closeFilters"
                class="flex h-10 w-10 items-center justify-center rounded-full border border-slate-200 bg-white text-slate-400 transition hover:text-deep-navy"
                type="button"
              >
                <span class="material-symbols-outlined">close</span>
              </button>
            </div>
            <form class="space-y-6" id="filterForm">
              <section class="space-y-3">
                <div class="flex items-center justify-between">
                  <p class="text-sm font-semibold text-deep-navy">Price per night</p>
                  <button class="text-xs font-semibold text-sea-teal" id="filterReset" type="button">
                    Reset
                  </button>
                </div>
                <div class="grid grid-cols-2 gap-3 text-sm">
                  <label class="filter-chip flex cursor-pointer items-center gap-2 rounded-2xl border border-slate-200 px-3 py-3 font-medium text-slate-600 transition hover:border-sea-teal/40 hover:text-deep-navy" data-checked="false">
                    <input class="sr-only" name="price" type="radio" value="budget" />
                    <span class="material-symbols-outlined text-[18px] text-sea-teal">sell</span>
                    Budget (â‰¤ â‚±2,000)
                  </label>
                  <label class="filter-chip flex cursor-pointer items-center gap-2 rounded-2xl border border-slate-200 px-3 py-3 font-medium text-slate-600 transition hover:border-sea-teal/40 hover:text-deep-navy" data-checked="false">
                    <input class="sr-only" name="price" type="radio" value="mid" />
                    <span class="material-symbols-outlined text-[18px] text-sea-teal">equal</span>
                    Mid-range (â‚±2,001 â€“ â‚±4,000)
                  </label>
                  <label class="filter-chip flex cursor-pointer items-center gap-2 rounded-2xl border border-slate-200 px-3 py-3 font-medium text-slate-600 transition hover:border-sea-teal/40 hover:text-deep-navy" data-checked="false">
                    <input class="sr-only" name="price" type="radio" value="premium" />
                    <span class="material-symbols-outlined text-[18px] text-sea-teal">workspace_premium</span>
                    Premium (â‰¥ â‚±4,001)
                  </label>
                  <label class="filter-chip flex cursor-pointer items-center gap-2 rounded-2xl border border-slate-200 px-3 py-3 font-medium text-slate-600 transition hover:border-sea-teal/40 hover:text-deep-navy" data-checked="true">
                    <input checked class="sr-only" name="price" type="radio" value="any" />
                    <span class="material-symbols-outlined text-[18px] text-sea-teal">orbit</span>
                    Any budget
                  </label>
                </div>
              </section>

              <section class="space-y-3">
                <p class="text-sm font-semibold text-deep-navy">Stay type</p>
                <div class="flex flex-wrap gap-2 text-sm" id="typeChips">
                  <label class="filter-chip flex cursor-pointer items-center gap-2 rounded-full border border-slate-200 px-3 py-2 font-medium text-slate-600 transition hover:border-sea-teal/40 hover:text-deep-navy" data-checked="true">
                    <input checked class="sr-only" name="type" type="checkbox" value="all" />
                    <span class="material-symbols-outlined text-[18px] text-sea-teal">blur_on</span>
                    All stays
                  </label>
                  <label class="filter-chip flex cursor-pointer items-center gap-2 rounded-full border border-slate-200 px-3 py-2 font-medium text-slate-600 transition hover:border-sea-teal/40 hover:text-deep-navy" data-checked="false">
                    <input class="sr-only" name="type" type="checkbox" value="Dormitory" />
                    Dormitory
                  </label>
                  <label class="filter-chip flex cursor-pointer items-center gap-2 rounded-full border border-slate-200 px-3 py-2 font-medium text-slate-600 transition hover:border-sea-teal/40 hover:text-deep-navy" data-checked="false">
                    <input class="sr-only" name="type" type="checkbox" value="Studio" />
                    Studio
                  </label>
                  <label class="filter-chip flex cursor-pointer items-center gap-2 rounded-full border border-slate-200 px-3 py-2 font-medium text-slate-600 transition hover:border-sea-teal/40 hover:text-deep-navy" data-checked="false">
                    <input class="sr-only" name="type" type="checkbox" value="Apartment" />
                    Apartment
                  </label>
                  <label class="filter-chip flex cursor-pointer items-center gap-2 rounded-full border border-slate-200 px-3 py-2 font-medium text-slate-600 transition hover:border-sea-teal/40 hover:text-deep-navy" data-checked="false">
                    <input class="sr-only" name="type" type="checkbox" value="Private Room" />
                    Private Room
                  </label>
                </div>
              </section>

              <section class="flex items-center justify-between rounded-2xl bg-soft-gray px-4 py-3">
                <div>
                  <p class="text-sm font-semibold text-deep-navy">Verified only</p>
                  <p class="text-xs text-slate-500">Show listings vetted by SafeStay</p>
                </div>
                <label class="relative inline-flex cursor-pointer items-center">
                  <input class="peer sr-only" id="verifiedOnly" type="checkbox" />
                  <span class="h-6 w-11 rounded-full bg-slate-300 transition peer-checked:bg-sea-teal"></span>
                  <span class="absolute left-0.5 top-0.5 h-5 w-5 rounded-full bg-white transition peer-checked:translate-x-5 peer-checked:bg-white"></span>
                </label>
              </section>

              <div class="flex items-center justify-between gap-3">
                <button
                  class="w-full rounded-xl border border-slate-200 bg-white py-3 text-sm font-semibold text-slate-500 transition hover:border-slate-300"
                  id="cancelFilters"
                  type="button"
                >
                  Cancel
                </button>
                <button
                  class="w-full rounded-xl bg-deep-navy py-3 text-sm font-semibold text-white shadow-md transition hover:bg-opacity-95"
                  type="submit"
                >
                  Apply filters
                </button>
              </div>
            </form>
          </div>
        </aside>

        <section
          aria-label="Listing preview drawer"
          class="fixed inset-y-20 right-5 z-30 hidden w-80 max-w-sm flex-col overflow-hidden rounded-3xl border border-white/60 bg-white/95 shadow-surface backdrop-blur-xl transition-transform duration-200 ease-out lg:flex"
          id="listDrawer"
        >
          <div class="flex items-center justify-between px-5 pb-3 pt-5">
            <div>
              <h2 class="text-base font-semibold">Nearby results</h2>
              <p class="text-xs text-slate-500" id="drawerCount"></p>
            </div>
            <button id="closeList" class="flex h-9 w-9 items-center justify-center rounded-full border border-slate-200 text-slate-500 transition hover:text-deep-navy" type="button">
              <span class="material-symbols-outlined">chevron_right</span>
            </button>
          </div>
          <div class="scrollbar-hidden flex-1 space-y-4 overflow-y-auto px-5 pb-5" id="drawerListings"></div>
        </section>
      </main>

      <nav class="fixed inset-x-0 bottom-0 z-50 border-t border-slate-200 bg-white/95 backdrop-blur">
        <ul class="grid grid-cols-5 text-xs">
          <li>
            <a
              class="flex flex-col items-center justify-center py-2 text-slate-600 hover:text-deep-navy"
              data-tab="home"
              href="home.html"
            >
              <span class="material-symbols-outlined text-[22px]">home</span>
              <span class="mt-1 text-[10px] leading-none">Home</span>
            </a>
          </li>
          <li>
            <a
              class="flex flex-col items-center justify-center py-2 text-deep-navy"
              data-tab="map"
              href="interactive-map.html"
            >
              <span class="material-symbols-outlined text-[22px] text-deep-navy">map</span>
              <span class="mt-1 text-[10px] leading-none font-semibold">Map</span>
            </a>
          </li>
          <li>
            <a
              class="flex flex-col items-center justify-center py-2 text-slate-600 hover:text-deep-navy"
              data-tab="saved"
              href="saved.html"
            >
              <span class="material-symbols-outlined text-[22px]">bookmark</span>
              <span class="mt-1 text-[10px] leading-none">Saved</span>
            </a>
          </li>
          <li>
            <a
              class="flex flex-col items-center justify-center py-2 text-slate-600 hover:text-deep-navy"
              data-tab="messages"
              href="message_threads.html"
            >
              <span class="material-symbols-outlined text-[22px]">chat</span>
              <span class="mt-1 text-[10px] leading-none">Messages</span>
            </a>
          </li>
          <li>
            <a
              class="flex flex-col items-center justify-center py-2 text-slate-600 hover:text-deep-navy"
              data-tab="profile"
              href="profile.html"
            >
              <span class="material-symbols-outlined text-[22px]">person</span>
              <span class="mt-1 text-[10px] leading-none">Profile</span>
            </a>
          </li>
        </ul>
      </nav>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const listings = [
          {
            id: "sunset-dorm",
            title: "Sunset View Dormitory",
            location: "Espaa Blvd, Sampaloc, Manila",
            price: 2500,
            rating: 4.9,
            reviews: 22,
            type: "Dormitory",
            badges: ["Free Wi-Fi", "Laundry Included"],
            image: "Images/home bh 1.png",
            position: { x: 42, y: 55 },
            isVerified: true,
            isSaved: true,
          },
          {
            id: "campus-loft",
            title: "Campus Loft Studio",
            location: "Laong Laan Street, Manila",
            price: 3800,
            rating: 4.7,
            reviews: 18,
            type: "Studio",
            badges: ["City View", "Kitchenette"],
            image: "Images/private studio.png",
            position: { x: 58, y: 38 },
            isVerified: true,
            isSaved: false,
          },
          {
            id: "cozy-nook",
            title: "Cozy Nook Apartment",
            location: "Maria Clara Street, Quezon City",
            price: 4600,
            rating: 4.8,
            reviews: 31,
            type: "Apartment",
            badges: ["Near LRT", "Air-Conditioned"],
            image: "Images/cozy bh 4.avif",
            position: { x: 68, y: 62 },
            isVerified: true,
            isSaved: false,
          },
          {
            id: "green-haven",
            title: "Green Haven Private Room",
            location: "P. Noval Street, Manila",
            price: 1800,
            rating: 4.5,
            reviews: 12,
            type: "Private Room",
            badges: ["Study Desk", "Shared Pantry"],
            image: "Images/home bh 2.png",
            position: { x: 30, y: 44 },
            isVerified: false,
            isSaved: false,
          },
          {
            id: "north-hub",
            title: "North Hub Dorm",
            location: "Dapitan Street, Manila",
            price: 2100,
            rating: 4.6,
            reviews: 17,
            type: "Dormitory",
            badges: ["Study Lounge", "Security 24/7"],
            image: "Images/home bh 6.png",
            position: { x: 18, y: 32 },
            isVerified: true,
            isSaved: true,
          },
        ];

        const clusters = [
          {
            id: "north-cluster",
            label: "5+",
            position: { x: 62, y: 26 },
          },
        ];

        const state = {
          selectedId: listings[0]?.id ?? null,
          zoom: 1,
          filters: {
            price: "any",
            types: new Set(["all"]),
            verifiedOnly: false,
          },
          drawerOpen: false,
        };

        const mapCanvas = document.getElementById("mapCanvas");
        const markerLayer = document.getElementById("markerLayer");
        const clusterLayer = document.getElementById("clusterLayer");
        const zoomIn = document.getElementById("zoomIn");
        const zoomOut = document.getElementById("zoomOut");
        const zoomValue = document.getElementById("zoomValue");
        const listingCard = document.getElementById("listingCard");
        const listingImage = document.getElementById("listingImage");
        const listingTitle = document.getElementById("listingTitle");
        const listingLocation = document.getElementById("listingLocation");
        const listingRating = document.getElementById("listingRating");
        const listingReviews = document.getElementById("listingReviews");
        const listingType = document.getElementById("listingType");
        const listingPrice = document.getElementById("listingPrice");
        const listingBadge = document.getElementById("listingBadge");
        const listingAmenities = document.getElementById("listingAmenities");
        const saveButton = document.getElementById("saveButton");
        const saveIcon = document.getElementById("saveIcon");
        const viewDetails = document.getElementById("viewDetails");
        const openFilters = document.getElementById("openFilters");
        const closeFilters = document.getElementById("closeFilters");
        const cancelFilters = document.getElementById("cancelFilters");
        const filterDrawer = document.getElementById("filterDrawer");
        const filterForm = document.getElementById("filterForm");
        const filterReset = document.getElementById("filterReset");
        const verifiedOnly = document.getElementById("verifiedOnly");
        const typeChips = document.getElementById("typeChips");
        const toggleList = document.getElementById("toggleList");
        const listDrawer = document.getElementById("listDrawer");
        const closeList = document.getElementById("closeList");
        const drawerListings = document.getElementById("drawerListings");
        const drawerCount = document.getElementById("drawerCount");

        const moveDrawer = (open) => {
          state.drawerOpen = open;
          const translate = open ? "translate-x-0" : "translate-x-[120%]";
          listDrawer.classList.remove("translate-x-0", "translate-x-[120%]");
          listDrawer.classList.add(translate);
        };

        const formatCurrency = (value) => `\u20B1${value.toLocaleString("en-PH")}`;

        const categories = {
          budget: (price) => price <= 2000,
          mid: (price) => price > 2000 && price <= 4000,
          premium: (price) => price > 4000,
          any: () => true,
        };

        const filteredListings = () =>
          listings.filter((listing) => {
            const matchesPrice = categories[state.filters.price](listing.price);
            const matchesVerified = !state.filters.verifiedOnly || listing.isVerified;
            const types = state.filters.types;
            const matchesType =
              types.has("all") || types.has(listing.type) || types.size === 0;
            return matchesPrice && matchesVerified && matchesType;
          });

        const updateZoom = () => {
          mapCanvas.style.setProperty("--zoom-scale", state.zoom.toString());
          markerLayer.style.setProperty("--zoom-scale", state.zoom.toString());
          clusterLayer.style.setProperty("--zoom-scale", state.zoom.toString());
          zoomValue.textContent = `${Math.round(state.zoom * 100)}%`;
        };

        const setSelected = (id) => {
          state.selectedId = id;
          updateListingPanel();
          updateMarkers();
        };

        const buildAmenityPill = (label) => {
          const pill = document.createElement("span");
          pill.className = "inline-flex items-center gap-2 rounded-full bg-soft-gray px-3 py-1 text-xs font-semibold text-deep-navy";
          pill.textContent = label;
          return pill;
        };

        const updateListingPanel = () => {
          const listing = listings.find((item) => item.id === state.selectedId);
          if (!listing) {
            listingCard.classList.add("hidden");
            return;
          }
          listingCard.classList.remove("hidden");
          listingImage.src = listing.image;
          listingImage.alt = listing.title;
          listingTitle.textContent = listing.title;
          listingLocation.textContent = listing.location;
          listingRating.textContent = listing.rating.toFixed(1);
          listingReviews.textContent = `${listing.reviews} reviews`;
          listingType.textContent = listing.type;
          listingPrice.textContent = `${formatCurrency(listing.price)} / night`;
          listingBadge.textContent = listing.isVerified ? "Verified" : "Student favorite";
          listingBadge.classList.toggle("text-sea-teal", listing.isVerified);
          listingBadge.classList.toggle("text-amber-600", !listing.isVerified);
          listingBadge.classList.toggle("bg-sea-teal/15", listing.isVerified);
          listingBadge.classList.toggle("bg-amber-100", !listing.isVerified);
          listingAmenities.innerHTML = "";
          listing.badges.forEach((badge) => {
            listingAmenities.appendChild(buildAmenityPill(badge));
          });
          saveIcon.textContent = listing.isSaved ? "favorite" : "favorite_border";
          saveIcon.classList.toggle("text-sea-teal", listing.isSaved);
          saveIcon.classList.toggle("text-slate-400", !listing.isSaved);
        };

        const renderClusterMarkers = () => {
          clusterLayer.innerHTML = "";
          clusters.forEach((cluster) => {
            const marker = document.createElement("div");
            marker.className = "marker-cluster";
            marker.style.left = `${cluster.position.x}%`;
            marker.style.top = `${cluster.position.y}%`;
            marker.textContent = cluster.label;
            clusterLayer.appendChild(marker);
          });
        };

        const updateMarkers = () => {
          const available = filteredListings();
          markerLayer.innerHTML = "";
          available.forEach((listing) => {
            const button = document.createElement("button");
            button.type = "button";
            button.className = "marker-button";
            button.dataset.id = listing.id;
            button.dataset.type = listing.isSaved ? "saved" : "default";
            button.style.left = `${listing.position.x}%`;
            button.style.top = `${listing.position.y}%`;
            button.title = listing.title;
            button.innerHTML = listing.isSaved
              ? '<span class="material-symbols-outlined text-[18px]">favorite</span>'
              : '<span class="material-symbols-outlined text-[18px]">home</span>';
            button.dataset.active = listing.id === state.selectedId ? "true" : "false";
            button.addEventListener("click", () => setSelected(listing.id));
            markerLayer.appendChild(button);
          });

          if (!available.find((listing) => listing.id === state.selectedId)) {
            setSelected(available[0]?.id ?? null);
          }

          updateDrawer(available);
        };

        const updateDrawer = (available) => {
          drawerListings.innerHTML = "";
          drawerCount.textContent = `${available.length} listing${available.length === 1 ? "" : "s"} nearby`;
          available.forEach((listing) => {
            const card = document.createElement("button");
            card.type = "button";
            card.className = `flex w-full items-center gap-3 rounded-2xl border border-transparent bg-white/90 px-3 py-3 text-left shadow-sm transition hover:border-sea-teal/40 ${listing.id === state.selectedId ? "border-sea-teal/60" : ""}`;
            card.innerHTML = `
              <img src="${listing.image}" alt="${listing.title}" class="h-16 w-16 flex-shrink-0 rounded-xl object-cover" />
              <div class="flex-1 space-y-1">
                <p class="text-sm font-semibold text-deep-navy">${listing.title}</p>
                <p class="text-xs text-slate-500">${listing.location}</p>
                <div class="flex items-center gap-2 text-xs text-slate-500">
                  <span class="text-sea-teal">${formatCurrency(listing.price)}</span>
                  <span>Â· ${listing.type}</span>
                </div>
              </div>
              <span class="material-symbols-outlined text-[18px] text-slate-300">chevron_right</span>
            `;
            card.addEventListener("click", () => setSelected(listing.id));
            drawerListings.appendChild(card);
          });
        };

        const toggleDrawer = () => {
          listDrawer.classList.toggle("hidden");
          requestAnimationFrame(() => moveDrawer(!listDrawer.classList.contains("hidden")));
        };

        zoomIn.addEventListener("click", () => {
          state.zoom = Math.min(1.6, parseFloat((state.zoom + 0.1).toFixed(2)));
          updateZoom();
        });

        zoomOut.addEventListener("click", () => {
          state.zoom = Math.max(0.8, parseFloat((state.zoom - 0.1).toFixed(2)));
          updateZoom();
        });

        openFilters.addEventListener("click", () => {
          filterDrawer.classList.remove("translate-y-full");
        });

        const closeFilterDrawer = () => {
          filterDrawer.classList.add("translate-y-full");
        };

        closeFilters.addEventListener("click", closeFilterDrawer);
        cancelFilters.addEventListener("click", closeFilterDrawer);

        filterReset.addEventListener("click", () => {
          filterForm.reset();
          state.filters.price = "any";
          state.filters.types = new Set(["all"]);
          state.filters.verifiedOnly = false;
          verifiedOnly.checked = false;
          refreshChipState();
          updateMarkers();
        });

        verifiedOnly.addEventListener("change", (event) => {
          state.filters.verifiedOnly = event.target.checked;
        });

        typeChips.addEventListener("change", (event) => {
          const input = event.target;
          if (input.tagName.toLowerCase() !== "input") return;
          if (input.value === "all" && input.checked) {
            state.filters.types = new Set(["all"]);
            const inputs = typeChips.querySelectorAll('input[name="type"]');
            inputs.forEach((ctrl) => {
              if (ctrl.value !== "all") ctrl.checked = false;
            });
          } else if (input.checked) {
            state.filters.types.delete("all");
            state.filters.types.add(input.value);
            typeChips.querySelector('input[value="all"]').checked = false;
          } else {
            state.filters.types.delete(input.value);
            if (state.filters.types.size === 0) {
              state.filters.types.add("all");
              typeChips.querySelector('input[value="all"]').checked = true;
            }
          }
          refreshChipState();
        });

        const refreshChipState = () => {
          document.querySelectorAll(".filter-chip").forEach((chip) => {
            const input = chip.querySelector("input");
            chip.dataset.checked = input?.checked ? "true" : "false";
          });
        };

        filterForm.addEventListener("submit", (event) => {
          event.preventDefault();
          const formData = new FormData(filterForm);
          state.filters.price = formData.get("price") ?? "any";
          state.filters.verifiedOnly = verifiedOnly.checked;
          refreshChipState();
          updateMarkers();
          closeFilterDrawer();
        });

        toggleList.addEventListener("click", toggleDrawer);
        closeList.addEventListener("click", () => {
          listDrawer.classList.add("hidden");
          moveDrawer(false);
        });

        saveButton.addEventListener("click", () => {
          const listing = listings.find((item) => item.id === state.selectedId);
          if (!listing) return;
          listing.isSaved = !listing.isSaved;
          saveIcon.textContent = listing.isSaved ? "favorite" : "favorite_border";
          updateMarkers();
        });

        viewDetails.addEventListener("click", () => {
          const listing = listings.find((item) => item.id === state.selectedId);
          if (!listing) return;
          window.location.href = "house_details.html";
        });

        renderClusterMarkers();
        updateMarkers();
        updateListingPanel();
        updateZoom();
        refreshChipState();
        listDrawer.classList.add("hidden", "translate-x-[120%]");
      });
    </script>
  </body>
</html>
